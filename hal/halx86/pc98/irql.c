/*
 * PROJECT:     NEC PC-98 series HAL
 * LICENSE:     GPL-2.0-or-later (https://spdx.org/licenses/GPL-2.0-or-later)
 * PURPOSE:     IRQL mapping
 * COPYRIGHT:   Copyright 2020 Dmitry Borisov (di.sean@protonmail.com)
 */

/* INCLUDES *******************************************************************/

#include <hal.h>

/* GLOBALS ********************************************************************/

/* This table contains the static x86 PIC mapping between IRQLs and IRQs */
ULONG KiI8259MaskTable[32] =
{
    /*
     * See comments of the PC/AT version.
     */
    B32(00000000,00000000,00000000,00000000), /* IRQL 0 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 1 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 2 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 3 */
    B32(11111111,10000000,00000000,00000000), /* IRQL 4 */
    B32(11111111,11000000,00000000,00000000), /* IRQL 5 */
    B32(11111111,11100000,00000000,00000000), /* IRQL 6 */
    B32(11111111,11110000,00000000,00000000), /* IRQL 7 */
    B32(11111111,11111000,00000000,00000000), /* IRQL 8 */
    B32(11111111,11111100,00000000,00000000), /* IRQL 9 */
    B32(11111111,11111110,00000000,00000000), /* IRQL 10 */
    B32(11111111,11111111,00000000,00000000), /* IRQL 11 */

    /*
     * Okay, now we're finally starting to mask off IRQs on the slave PIC, from
     * IRQ15 to IRQ8. Note that the output of INT of RTC is connected to the IR7.
     * We need to keep this IRQ unmasked, so we can ensure profiling the whole system.
     */
    B32(11111111,11111111,00000000,00000000), /* IRQL 12 */
    B32(11111111,11111111,01000000,00000000), /* IRQL 13 */
    B32(11111111,11111111,01100000,00000000), /* IRQL 14 */
    B32(11111111,11111111,01110000,00000000), /* IRQL 15 */
    B32(11111111,11111111,01111000,00000000), /* IRQL 16 */
    B32(11111111,11111111,01111100,00000000), /* IRQL 17 */
    B32(11111111,11111111,01111110,00000000), /* IRQL 18 */
    B32(11111111,11111111,01111110,00000000), /* IRQL 19 */

    /*
     * Now we mask off the IRQs on the master. Since IRQL 19 we have 0 "droplet".
     * It's the cascade IRQ that we use to bridge the slave PIC with the master PIC.
     */
    B32(11111111,11111111,01111111,00000000), /* IRQL 20 */
    B32(11111111,11111111,01111111,01000000), /* IRQL 21 */
    B32(11111111,11111111,01111111,01100000), /* IRQL 22 */
    B32(11111111,11111111,01111111,01110000), /* IRQL 23 */
    B32(11111111,11111111,01111111,01111000), /* IRQL 24 */
    B32(11111111,11111111,01111111,01111100), /* IRQL 25 */
    B32(11111111,11111111,01111111,01111110), /* IRQL 26 */
    B32(11111111,11111111,11111111,01111110), /* IRQL 27 */

    /*
     * See comments of the PC/AT version.
     */
    B32(11111111,11111111,11111111,01111111), /* IRQL 28 */
    B32(11111111,11111111,11111111,01111111), /* IRQL 29 */
    B32(11111111,11111111,11111111,01111111), /* IRQL 30 */
    B32(11111111,11111111,11111111,01111111)  /* IRQL 31 */
};

/* This table indicates which IRQs, if pending, can preempt a given IRQL level */
ULONG FindHigherIrqlMask[32] =
{
    /*
     * See comments of the PC/AT version.
     */
    B32(11111111,11111111,11111111,11111110), /* IRQL 0 */
    B32(11111111,11111111,11111111,11111100), /* IRQL 1 */
    B32(11111111,11111111,11111111,11111000), /* IRQL 2 */
    B32(11111111,11111111,11111111,11110000), /* IRQL 3 */
    B32(00000111,11111111,11111111,11110000), /* IRQL 4 */
    B32(00000011,11111111,11111111,11110000), /* IRQL 5 */
    B32(00000001,11111111,11111111,11110000), /* IRQL 6 */
    B32(00000000,11111111,11111111,11110000), /* IRQL 7 */
    B32(00000000,01111111,11111111,11110000), /* IRQL 8 */
    B32(00000000,00111111,11111111,11110000), /* IRQL 9 */
    B32(00000000,00011111,11111111,11110000), /* IRQL 10 */

    /*
     * Now we start progressivly limiting which slave PIC interrupts have the
     * right to preempt us at each level. The RTC timer used for profiling,
     * so it will always preempt until we reach PROFILE_LEVEL.
     */
    B32(00000000,00001111,11111111,11110000), /* IRQL 11 */
    B32(00000000,00001111,11111111,11110000), /* IRQL 12 */
    B32(00000000,00001011,11111111,11110000), /* IRQL 13 */
    B32(00000000,00001001,11111111,11110000), /* IRQL 14 */
    B32(00000000,00001000,11111111,11110000), /* IRQL 15 */
    B32(00000000,00001000,01111111,11110000), /* IRQL 16 */
    B32(00000000,00001000,00111111,11110000), /* IRQL 17 */
    B32(00000000,00001000,00011111,11110000), /* IRQL 18 */
    B32(00000000,00001000,00011111,11110000), /* IRQL 19 */

    /*
     * Now with IRQs on the master PIC.
     */
    B32(00000000,00001000,00000111,11110000), /* IRQL 20 */
    B32(00000000,00001000,00000011,11110000), /* IRQL 21 */
    B32(00000000,00001000,00000001,11110000), /* IRQL 22 */
    B32(00000000,00001000,00000000,11110000), /* IRQL 23 */
    B32(00000000,00001000,00000000,01110000), /* IRQL 24 */
    B32(00000000,00001000,00000000,00110000), /* IRQL 25 */
    B32(00000000,00001000,00000000,00010000), /* IRQL 26 */

    /*
     * See comments of the PC/AT version.
     */
    B32(00000000,00000000,00000000,00010000), /* IRQL 27 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 28 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 29 */
    B32(00000000,00000000,00000000,00000000), /* IRQL 30 */
    B32(00000000,00000000,00000000,00000000)  /* IRQL 31 */
};
